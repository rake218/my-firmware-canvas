name: Embedded C Challenges CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build-and-test-host:
    name: Build & Test (host)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install apt packages
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential cmake

      - name: Show environment
        run: |
          echo "Runner info:"
          uname -a
          gcc --version
          cmake --version

      - name: Run test runner (host)
        # call via bash so executable permission is NOT required
        run: bash ./tools/run_all_tests.sh

      - name: CI summary (host)
        if: ${{ success() }}
        run: echo "All host-based tests passed."

  per-challenge-docker:
    name: Per-challenge Docker builds & tests
    runs-on: ubuntu-latest
    needs: build-and-test-host
    permissions:
      contents: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Docker Buildx (optional)
        uses: docker/setup-buildx-action@v2

      - name: Build & run per-challenge images
        env:
          REPO_ROOT: ${{ github.workspace }}
        run: |
          set -euo pipefail
          echo "Searching for per-challenge Dockerfiles..."
          FOUND=0
          for d in challenges/*; do
            if [ -f "$d/Dockerfile" ]; then
              FOUND=1
              CHALLENGE_NAME=$(basename "$d")
              IMAGE_NAME="mfc-${CHALLENGE_NAME}:ci"
              echo "=== Building image for $CHALLENGE_NAME ==="
              docker build -t "$IMAGE_NAME" "$d"
              echo "=== Running tests for $CHALLENGE_NAME inside image ==="
              docker run --rm -v "${REPO_ROOT}":/workspace -w /workspace/"$d" \
                "$IMAGE_NAME" bash -lc '
                  set -euo pipefail
                  echo "Container: inspecting challenge dir: $(pwd)"

                  # 1) explicit harness at tests/run_tests.sh
                  if [ -f tests/run_tests.sh ]; then
                    echo "Found tests/run_tests.sh"
                    chmod +x tests/run_tests.sh || true
                    exec bash tests/run_tests.sh
                  fi

                  # 2) any shell test scripts tests/*.sh
                  shopt -s nullglob || true
                  shopt -s globstar || true
                  sh_tests=(tests/*.sh)
                  if [ "${#sh_tests[@]}" -gt 0 ]; then
                    echo "Found shell test scripts: ${sh_tests[*]}"
                    for s in "${sh_tests[@]}"; do
                      chmod +x "$s" || true
                      echo "Running $s"
                      bash "$s"
                    done
                    exit 0
                  fi

                  # 3) Makefile target `make test`
                  if [ -f Makefile ]; then
                    echo "Found Makefile — running make test"
                    make test
                    exit 0
                  fi

                  # 4) C host tests: compile tests/test_*.c if present
                  ctests=(tests/test_*.c)
                  if [ "${#ctests[@]}" -gt 0 ]; then
                    for c in "${ctests[@]}"; do
                      exe="${c%.c}.exe"
                      echo "Compiling $c -> $exe"
                      gcc -Wall -Werror -O2 -std=c99 -I../src "$c" ../src/*.c -o "$exe"
                      echo "Running $exe"
                      "./$exe"
                    done
                    exit 0
                  fi

                  echo "No test entrypoint found in $(pwd). Skipping."
                  exit 0
                '
              echo "=== $CHALLENGE_NAME completed ==="
            fi
          done
          if [ "$FOUND" -eq 0 ]; then
            echo "No per-challenge Dockerfiles found — skipping per-challenge job."
          fi

      - name: Per-challenge summary
        if: ${{ success() }}
        run: echo "All per-challenge Docker tests passed."
