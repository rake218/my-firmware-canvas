name: Embedded C Challenges CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build-and-test-host:
    name: Build & Test (host)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install apt packages
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential cmake

      - name: Show environment
        run: |
          echo "Runner info:"
          uname -a
          gcc --version
          cmake --version

      - name: Run test runner (host)
        run: bash ./tools/run_all_tests.sh

      - name: CI summary (host)
        if: ${{ success() }}
        run: echo "All host-based tests passed."

  per-challenge-docker:
    name: Per-challenge Docker builds & tests
    runs-on: ubuntu-latest
    needs: build-and-test-host
    permissions:
      contents: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Build & run per-challenge images
        env:
          REPO_ROOT: ${{ github.workspace }}
        run: |
          set -euo pipefail
          echo "Searching for per-challenge Dockerfiles..."
          FOUND=0
          for d in challenges/*; do
            if [ -f "$d/Dockerfile" ]; then
              FOUND=1
              CHALLENGE_NAME=$(basename "$d")
              IMAGE_NAME="mfc-${CHALLENGE_NAME}:ci"
              echo "=== Building image for $CHALLENGE_NAME ==="
              docker build -t "$IMAGE_NAME" "$d"

              echo "=== Running tests for $CHALLENGE_NAME inside image ==="
              docker run --rm -v "${REPO_ROOT}":/workspace -w /workspace/"$d" \
                "$IMAGE_NAME" bash -lc '
                  set -euo pipefail
                  echo "Container: inspecting challenge dir: $(pwd)"
                  if [ -f tests/run_tests.sh ]; then
                    chmod +x tests/run_tests.sh || true
                    exec bash tests/run_tests.sh
                  elif [ -f Makefile ]; then
                    make test
                  else
                    echo "No test entrypoint found, skipping."
                  fi
                '

              # Upload build artifacts
              if [ -d "$d/build" ]; then
                echo "=== Uploading artifacts for $CHALLENGE_NAME ==="
                zip -r "${CHALLENGE_NAME}_build.zip" "$d/build"
                echo "Created artifact: ${CHALLENGE_NAME}_build.zip"
              fi

              echo "=== $CHALLENGE_NAME completed ==="
            fi
          done
          if [ "$FOUND" -eq 0 ]; then
            echo "No per-challenge Dockerfiles found â€” skipping per-challenge job."
          fi

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: firmware_builds
          path: |
            challenges/*/*build/
