name: Embedded C Challenges CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build-and-test-host:
    name: Build & Test (host)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install apt packages
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential cmake

      - name: Show environment
        run: |
          echo "Runner info:"
          uname -a
          gcc --version
          cmake --version

      - name: Run test runner (host)
        # call via bash so executable permission is NOT required
        run: bash ./tools/run_all_tests.sh

      - name: CI summary (host)
        if: ${{ success() }}
        run: echo "All host-based tests passed."

  per-challenge-docker:
    name: Per-challenge Docker builds & tests
    runs-on: ubuntu-latest
    needs: build-and-test-host     # optional: wait for the host job to finish first
    permissions: contents:read
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Docker Buildx (optional, speeds multi-platform builds)
        uses: docker/setup-buildx-action@v2

      - name: Login to Github Container Registry (optional, skip if not pushing images)
        if: false
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build & run per-challenge images
        env:
          REPO_ROOT: ${{ github.workspace }}
        run: |
          set -euo pipefail
          echo "Searching for per-challenge Dockerfiles..."
          FOUND=0
          for d in challenges/*; do
            if [ -f "$d/Dockerfile" ]; then
              FOUND=1
              CHALLENGE_NAME=$(basename "$d")
              IMAGE_NAME="mfc-${CHALLENGE_NAME}:ci"
              echo "=== Building image for $CHALLENGE_NAME ==="
              docker build -t "$IMAGE_NAME" "$d"
              echo "=== Running tests for $CHALLENGE_NAME inside image ==="
              # run the challenge's test target in the context of the mounted repo root
              docker run --rm -v "${REPO_ROOT}":/workspace -w /workspace/"$d" \
                "$IMAGE_NAME" bash -lc "chmod +x ./tests/test_linker.sh ./tests/test_linker.sh || (chmod +x ./tests/test_linker.sh && ./tests/test_linker.sh) || exit 1"
              echo "=== $CHALLENGE_NAME completed ==="
            fi
          done
          if [ "$FOUND" -eq 0 ]; then
            echo "No per-challenge Dockerfiles found â€” skipping per-challenge job."
          fi

      - name: Per-challenge summary
        if: ${{ success() }}
        run: echo "All per-challenge Docker tests passed."
